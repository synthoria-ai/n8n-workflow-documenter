# GitLab CI/CD Pipeline for n8n Workflow Documenter
# Automated build and deployment to server

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_IMAGE: "n8n-documenter"
  DOCKER_TAG: "${CI_COMMIT_SHORT_SHA}"
  APP_PORT: "3010"

# Build Docker image
build:
  stage: build
  image: docker:24-cli
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    - echo "Building Docker image..."
    - docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
    - docker build -t ${DOCKER_IMAGE}:latest .
    - echo "Docker image built successfully"
  only:
    - main
    - develop
  tags:
    - docker

# Test the application
test:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
  script:
    - echo "Running linter..."
    - npm run lint || true
    - echo "Tests completed"
  only:
    - main
    - develop
  tags:
    - docker

# Deploy to production server
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to production server..."
    
    # Create deployment directory
    - ssh $SERVER_USER@$SERVER_IP "mkdir -p /opt/n8n-documenter"
    
    # Copy files to server
    - scp -r Dockerfile docker-compose.yml .dockerignore next.config.mjs nginx-n8n-documenter.conf $SERVER_USER@$SERVER_IP:/opt/n8n-documenter/
    
    # Copy application code
    - ssh $SERVER_USER@$SERVER_IP "cd /opt/n8n-documenter && git clone https://github.com/synthoria-ai/n8n-workflow-documenter.git temp || (cd temp && git pull)"
    - ssh $SERVER_USER@$SERVER_IP "cd /opt/n8n-documenter && rsync -av --exclude='.git' temp/ ./ && rm -rf temp"
    
    # Build and start containers
    - ssh $SERVER_USER@$SERVER_IP "cd /opt/n8n-documenter && docker-compose down || true"
    - ssh $SERVER_USER@$SERVER_IP "cd /opt/n8n-documenter && docker-compose build"
    - ssh $SERVER_USER@$SERVER_IP "cd /opt/n8n-documenter && docker-compose up -d"
    
    # Health check
    - ssh $SERVER_USER@$SERVER_IP "sleep 10 && curl -f http://localhost:${APP_PORT} || exit 1"
    
    - echo "Deployment completed successfully!"
  only:
    - main
  environment:
    name: production
    url: https://documenter.yourdomain.com
  when: manual
  tags:
    - docker

# Deploy to staging server
deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $STAGING_SERVER_IP >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to staging server..."
    
    # Similar to production but with staging variables
    - ssh $STAGING_USER@$STAGING_SERVER_IP "mkdir -p /opt/n8n-documenter-staging"
    - scp -r Dockerfile docker-compose.yml .dockerignore next.config.mjs $STAGING_USER@$STAGING_SERVER_IP:/opt/n8n-documenter-staging/
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd /opt/n8n-documenter-staging && git clone https://github.com/synthoria-ai/n8n-workflow-documenter.git temp || (cd temp && git pull)"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd /opt/n8n-documenter-staging && rsync -av --exclude='.git' temp/ ./ && rm -rf temp"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd /opt/n8n-documenter-staging && docker-compose down || true"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd /opt/n8n-documenter-staging && docker-compose build"
    - ssh $STAGING_USER@$STAGING_SERVER_IP "cd /opt/n8n-documenter-staging && docker-compose up -d"
    
    - echo "Staging deployment completed!"
  only:
    - develop
  environment:
    name: staging
    url: https://documenter-staging.yourdomain.com
  tags:
    - docker

# Rollback deployment
rollback:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
  script:
    - echo "Rolling back deployment..."
    - ssh $SERVER_USER@$SERVER_IP "cd /opt/n8n-documenter && docker-compose down"
    - ssh $SERVER_USER@$SERVER_IP "cd /opt/n8n-documenter && git checkout HEAD~1"
    - ssh $SERVER_USER@$SERVER_IP "cd /opt/n8n-documenter && docker-compose up -d"
    - echo "Rollback completed"
  when: manual
  only:
    - main
  tags:
    - docker
